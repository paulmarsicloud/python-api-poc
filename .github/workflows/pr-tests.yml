name: Pull Request Tests

on:
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: poetry install --no-root

      - name: Build Docker image
        run: docker build .

      - name: Run tests
        run: poetry run pytest

      - name: Install minikube dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y conntrack socat curl

      - name: Set up Minikube
        uses: medyagh/setup-minikube@v0.0.14

      - name: Deploy to Minikube
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

      - name: Wait for service to be ready
        run: |
          echo "Waiting for pods..."
          kubectl rollout status deployment/python-api --timeout=60s

      - name: Port-forward and test endpoints
        run: |
          kubectl port-forward svc/python-api-service 8080:80 &
          sleep 5
          curl http://localhost:8080/terms
          curl http://localhost:8080/definitions\?term=person
